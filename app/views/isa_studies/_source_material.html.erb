<% study ||= nil %>
<% valid_study = study && study.sample_types.any? %>
<% sample_type = study&.sample_types&.first %>

<div style="padding:0 20px 20px 20px;">
    <div class="row">
        <div class="col-12">
            <table class="table table-striped table-bordered display nowrap" id="source-material-table" style="width:100%;"></table>
        </div>
    </div>
</div>

<div class="btn-group">
    <input class="btn btn-default dt-action" type="button" value="Add row" onClick="SourceAddNewRow()" />
    <input class="btn btn-default dt-action" type="button" value="Paste From Clipboard" onClick="SourcePasteFromClipboard()" />
    <input class="btn btn-default dt-action" type="button" value="Delete selected" onClick="SourceSetAsDeleted()" />
    <button class="btn btn-primary dt-action" id="btn_save_source" onClick="SourceSave()">Save</button>
</div>


<% if valid_study %>
    <script>
    // TODO: Load data in a separeta script tag and remove it after DT is loaded
    
        var sourceDynamicTable 
        let initialLoad = true;
        $j(document).ready(function () {
            $j('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                $j.fn.dataTable.tables( {visible: true, api: true} ).columns.adjust();
            });
            let dt = <%= sanitize(dt_data(sample_type).to_json) %>
            sourceDynamicTable = new $j.dynamicTable('#source-material-table')
            const elem = $j("#btn_save_source")
            const options = {
               ajax:{
                    url: `/single_pages/${pid}/dynamic_table_data/`,
                    data: function(d) { 
                        if (initialLoad) {
                            initialLoad = false;
                            return;
                        }
                        d.sample_type_id = '<%=sample_type.id%>';
                        d.rows_pad = "true"
                    }
                },
                callback: () => studyDynamicTable.table.ajax.reload(),
                enableLoading: () => {
                    elem.append("<span class='loader' style='margin:2px 0 2px 5px'></span>")
                    $j(".dt-action").addClass("disabled")
                },
                disableLoading: () => {
                    elem.find(".loader").remove();
                    $j(".dt-action").removeClass("disabled")
                }
            }
            sourceDynamicTable.init(dt.rows, dt.columns, options)
            dt = []

            $j(".dataTables_scrollBody").css("min-height", "300px")
        });

        function SourcePasteFromClipboard(){
            sourceDynamicTable.pasteFromClipboard()
        }

        function SourceSave(){
            sourceDynamicTable.save()
        }

        function SourceSetAsDeleted(){
            sourceDynamicTable.setAsDeleted()
        }

        function SourceAddNewRow(){
            sourceDynamicTable.newRow()
        }
																														
    </script>
<% end %>
