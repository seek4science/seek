<% can_upload = true %>
<div id="upload-summary">
  <%= folding_panel("General Information", true, :id => "general-information-panel") do %>
    <% [@project, @study, @assay, @sample_type]. map do | asset | %>
      <% next if asset.nil? %>
      <% asset_name = asset.class.to_s.singularize %>
      <h4> <%= asset_name %> </h4>
      <p><b>ID: </b><span><%= asset.id%></span></p>
      <p><b>UUID: </b><span><%= asset.uuid %></span></p>
      <p><b>Title: </b><span><%= asset.title %></span></p>
      <% if asset_name == "Project"%>
        <% if current_user.person.member_of?(asset)%>
          <p><b><%= current_user.person.name %> is member of this project: </b><span class="glyphicon glyphicon-ok-sign" style="color: green;"></span></p>
        <% else %>
          <p><b><%= current_user.person.name %> is member of this project: </b> <span class="glyphicon glyphicon-remove-sign" style="color: red;"></span></p>
          <% can_upload = false %>
        <% end %>
      <% else %>
        <% if asset.can_edit?%>
          <p><b><%= current_user.person.name %> can edit: </b><span class="glyphicon glyphicon-ok-sign" style="color: green;"></span></p>
        <% else %>
          <p><b><%= current_user.person.name %> can edit: </b> <span class="glyphicon glyphicon-remove-sign" style="color: red;"></span></p>
        <% can_upload = false %>
        <% end %>
      <% end %>
      <hr>
    <% end %>
  <% end %>

  <% unless @new_samples.nil? or @new_samples.compact.none? %>
  <%= folding_panel("New Samples <span id='new-samples-counter' class='label label-primary'>#{@new_samples.size}</span>", true, :id => "new-samples-panel", :body_options => {:id => "new-samples-panel-content"},
  :help_text => "These samples have been detected as new samples and will be created.") do %>
    <div class="table-responsive">
      <table id="create-samples-table" class="table">
        <tr>
          <th></th>
          <% for key in @new_samples[0].keys %>
            <% unless key == 'uuid' %>
              <th><%= key %></th>
            <% end %>
          <% end %>
        </tr>
        <% for new_sample in @new_samples %>
          <% new_sample_id = UUID.generate %>
          <tr id='<%= "new-sample-#{new_sample_id}" %>'>
            <td><button id=<%= "remove-#{new_sample_id}" %> class="glyphicon glyphicon-trash danger" style="background-color:#d9534f;color:white;" onclick=<%= "removeSample('new-sample-#{new_sample_id}')" %>></button></td>
              <% new_sample.map do |key, val| %>
                <% val = '<new>' if key =='id' %>
              <% unless key == 'uuid' %>
                <td id='<%= "new-sample-#{new_sample_id}[#{key}]" %>' ><%= val %></td>
              <% end %>
            <% end %>
          </tr>
        <% end %>
      </table>
    </div>
  <% end %>
<% end %>

 <% unless @update_samples.nil? or @update_samples.compact.none? %>
  <%= folding_panel("Samples to Update <span id='update-samples-counter' class='label label-warning'>#{@update_samples.size}</span>", true, :id => "existing-samples-panel", :body_options => {:id => "existing-samples-panel-content"},
  :help_text => "These samples were detected existing samples and will be updated.") do %>
    <div class="table-responsive">
      <table id="update-samples-table" class="table">
        <tr>
          <th></th>
          <% for key in @update_samples[0].keys %>
            <% unless key == 'uuid' %>
              <th><%= key %></th>
            <% end %>
          <% end %>
        </tr>
        <% for update_sample in @update_samples %>
          <tr id='<%= "update-sample-#{update_sample['id']}-updated" %>' >
            <% db_sample = @db_samples.select { |s| s['id'] == update_sample['id'] }.first %>
            <td rowspan=2><button id=<%= "remove-#{update_sample['id']}" %> class="glyphicon glyphicon-trash danger" style="background-color:#d9534f;color:white;" onclick=<%= "removeSample('update-sample-#{update_sample['id']}')" %>></button></td>
            <% update_sample.map do |key, val| %>
              <% unless key == 'uuid' %>
                <td class='<%= (val != db_sample[key]) ? "warning" : "default" %>' id='<%= "update-sample-#{update_sample['id']}[#{key}]"%>' ><%= val %></td>
              <% end %>
            <% end %>
          </tr>
          <tr id='<%= "update-sample-#{update_sample['id']}-original" %>' >
            <% db_sample.map do |key, val| %>
              <% unless key == 'uuid' %>
                <td><%= val %></td>
              <% end %>
            <% end %>
          </tr>
        <% end %>
      </table>
    </div>
  <% end %>
<% end %>

<% unless @possible_duplicates.nil? or @possible_duplicates.compact.none? %>
  <%= folding_panel("Possible Duplicates <span id='duplicate-samples-counter' class='label label-danger'>#{@possible_duplicates.size}</span>", true, :id => "existing-samples-panel", :body_options => {:id => "existing-samples-panel-content"},
                  :help_text => "These new samples have been matched to already existing samples.") do %>
    <div class="table-responsive">
      <table id="duplicate-samples-table" class="table">
        <tr>
          <th></th>
          <% for key in @possible_duplicates[0].keys %>
            <% unless %w[uuid duplicate].include?(key) %>
              <th><%= key %></th>
            <% end %>
          <% end %>
        </tr>
        <% for dupl_sample in @possible_duplicates %>
          <tr id='<%= "duplicate-sample-#{dupl_sample['duplicate']['id']}-1" %>' >
            <td rowspan=2><button id=<%= "remove-#{dupl_sample['duplicate']['id']}" %> class="glyphicon glyphicon-trash danger" style="background-color:#d9534f;color:white;" onclick=<%= "removeSample('duplicate-sample-#{dupl_sample['duplicate']['id']}')" %>></button></td>
          <% dupl_sample.map do |key, val| %>
            <% val = '<new>' if key =='id' %>
            <% unless %w[uuid duplicate].include?(key) %>
              <td id='<%= "#{dupl_sample['duplicate']['id']}[#{key}]" %>' ><%= val %></td>
            <% end %>
          <% end %>
            <tr id='<%= "duplicate-sample-#{dupl_sample['duplicate']['id']}-2" %>' class="danger">
              <% dupl_sample['duplicate'].map do |key, val| %>
                <% unless %w[uuid duplicate].include?(key) %>
                  <td><%= val %></td>
                <% end %>
              <% end %>
            </tr>
          </tr>
        <% end %>
      </table>
    </div>
  <% end %>
<% end %>

<div id='check-excel-upload-result'></div>
<% unless can_upload %>
  <div class="alert alert-danger alert-dismissible" role="alert">
      <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <h3>Error</h3>
      <strong>Unable to upload the current set of samples!</strong>
      <p>Please expand the 'General Information' pane for more information.</p>
  </div>
<% end %>

  <%= submit_tag "Upload", data: {disable_with: 'Uploading ...'}, :class => 'btn btn-primary', onclick: "submitUpload()" if can_upload%>
  <%= submit_tag "Cancel", data: {id: 'cancelModalUploadExcel'}, :class => 'btn btn-secondary', onclick: "closeModalForm()" %>
</div>

<script type="text/javascript">
  function removeSample(elementName){
    let counterName = ''
    if (/duplicate-sample/.test(elementName)){
      counterName = 'duplicate-samples-counter'
    } else if (/new-sample/.test(elementName)){
      counterName = 'new-samples-counter'
    } else if(/update-sample/.test(elementName)){
      counterName = 'update-samples-counter'
    }

    $j(`tr[id*='${elementName}']`).remove();
    debugger;
    const counter = parseInt($j(`span[id='${counterName}']`)[0].textContent);
    const newCounter = (counter > 0) ? (counter - 1) : counter;
    $j(`span[id='${counterName}']`).text(newCounter);
  }

  function submitUpload(){
    const newSamples = { data: getNewSamples() };
    const updatedSamples= { data: getUpdateSamples() };

    if(true){
      uploadAjaxCall("<%= batch_create_samples_path %>", "POST", { data: JSON.stringify(newSamples) });
      uploadAjaxCall("<%= batch_update_samples_path %>", "PUT", { data: JSON.stringify(updatedSamples) });
    }

    closeModalForm();
    location.reload();
  }

  // Retrieves the samples from the create-samples-table and the duplicate-samples-table
  function getNewSamples(){
    const newRows = $j('#create-samples-table tr:not(:has(th))').toArray();
    const duplicatedRows = $j('#duplicate-samples-table tr:not([class="danger"]):not(:has(th))').toArray();
    let createRows = newRows;

    if (duplicatedRows.length > 0 ) {
      if (confirm("Are you sure you want to add potentially duplicated rows?")) {
        createRows = createRows.concat(duplicatedRows);
      } else {
        closeModalForm();
        return;
      }
    }

    const sampleObjects = createRows.map((cr, index) => createSampleObject(cr, "new", index));

    return sampleObjects;
  }

  function getUpdateSamples(){
    const updateRows = $j('#update-samples-table [id*="updated"]').toArray();

    const sampleObjects = updateRows.map((ur, index) => createSampleObject(ur, "update", index));

    return sampleObjects
  }

  function createSampleObject(row, action, index){

    cells = $j(row).find('td:not(:has(".danger"))').toArray();
    samplesObj = {};
    cells.map(function(cell){
      val = cell.textContent;
      key = cell.id.match(/\[.*\]/)[0].replace('[', "").replace("]", '');
      samplesObj[key] = val;
    });

    const {id: objId, ...attrMap} = samplesObj;

    attrMap["status"] = action;

    if (action === "update"){
      return {
        id: objId,
        ex_id: `update-${index}-<%= @sample_type.id %>`,
        data: {
          type: "samples",
          attributes: {
            attribute_map: attrMap
          }
        }
      };
    } else {
        return {
          ex_id: `new-${index}-<%= @sample_type.id %>`,
            data:{
              type: "samples",
              tags: null,
              attributes: {
              policy: {
                access: getAccess(projectDefaultPolicy),
                permissions: [
                  {
                    resource: { type: "Project", id: <%= @project.id %> },
                    access: getPermission(projectDefaultPolicy, <%= @project.id %>)
                  }
                ]
              },
              attribute_map: attrMap
              },
              relationships: {
                projects: {
                  data: [
                    {type: "projects", id: <%= @project.id %>}
                  ]
                },
                sample_type: {
                  data: {
                    type: "sample_types",
                    id: <%= @sample_type.id %>
                  }
                }
              }
            }
        };
    }
  }
  function closeModalForm(){
    $j('#upload-excel-modal').modal('hide');
  }

  const uploadAjaxCall = (url, method, params) => {
    const { data, cache, dataType } = params;
    if (!url || !method) throw new Error("Parameter(s) missing");
    return $j.ajax({
      async: false,
      method,
      url,
      data,
      dataType,
      cache: cache || false,
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json"
      },
      success: function(res) {
        console.log("res", res);
      },
      error: function(err) {
        console.log("err", err);
      }
    });
  };

</script>
