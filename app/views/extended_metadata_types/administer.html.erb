<style>
  td {
      vertical-align: middle !important;
  }
</style>


<div class="row">
  <div class="col-md-3">
    <%= link_to new_extended_metadata_type_path, class: "btn btn-primary", role: "button", "aria-label" => "Left Align" do %>
      <span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span>
      Create Extended Metadata Type
    <% end %>
  </div>
</div>
<br>

<% nested, top_level = @extended_metadata_types.partition(&:extended_type?) %>
<% top_level.sort_by! { |emt| -emt.id } %>

<div class="alert alert-info">
  <p>
    You can disable Extended metadata types to prevent them from appearing as an option in the UI.
    Disabling them won't delete them, or where they've been used, and they can be re-enabled again here.
  </p>

  <p>
    If a type is disabled but has been used, for those cases it will no longer be shown when viewing those items.
    However, it will still be possible to edit the metadata for existing items and the metadata won't be deleted.
  </p>
</div>

<% if ExtendedMetadataType.disabled_but_in_use.any? %>
  <div class="alert alert-warning">
    <p>
      Extended metadata types that are in use have been disabled, and are high lighted below.
    </p>
    <p>
      The existing metadata won't be lost but will be hidden and the metadata type unavailable for new items.
    </p>
  </div>
<% end %>

<ul class="nav nav-tabs" role="tablist">
  <li class="nav-item active in">
    <a class="nav-link" id="top-level-tab" data-toggle="tab" href="#top-level-metadata-table" role="tab" aria-controls="top-level" aria-selected="true">Top Level</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="nested-tab" data-toggle="tab" href="#nested-metadata-table" role="tab" aria-controls="nested" aria-selected="false">Nested</a>
  </li>
  <li class="nav-item">
    <a class="nav-link" id="sample-controlled-vocabs-tab" data-toggle="tab" href="#sample_controlled_vocabs" role="tab" aria-controls="sample_controlled_vocabs" aria-selected="false">Sample Controlled Vocabs</a>
  </li>
</ul>

<div class="tab-content">
  <div class="tab-pane fade active in" id="top-level-metadata-table" role="tabpanel" aria-labelledby="top-level-tab">
    <table class='table table-hover' id='top-level-metadata-table'>
      <thead>
      <th>Internal Id</th>
      <th>Title</th>
      <th>Supported Type</th>
      <th>Number of<br/> times used</th>
      <th>Status</th>
      <th/>
      </thead>
      <tbody>
      <% top_level.each do |extended_metadata_type| %>
        <%= render partial: 'extended_metadata_type_table_row', locals: { extended_metadata_type: extended_metadata_type } %>
      <% end %>
      </tbody>
    </table>
  </div>

  <div class="tab-pane fade" id="nested-metadata-table" role="tabpanel" aria-labelledby="nested-tab">
    <table class='table table-hover' id='nested-metadata-table'>
      <thead>
      <th>Internal Id</th>
      <th>Title</th>
      <th>Supported Type</th>
      <th>Number of<br/> times used</th>
      <th>Status</th>
      <th/>
      </thead>
      <tbody>
      <% nested.each do |extended_metadata_type| %>
        <%= render partial: 'extended_metadata_type_table_row', locals: { extended_metadata_type: extended_metadata_type } %>
      <% end %>
      </tbody>
    </table>
  </div>

  <div class="tab-pane fade" id="sample_controlled_vocabs" role="tabpanel" aria-labelledby="sample-controlled-vocabs-tab">
    <table class='table table-hover' id='sample_controlled_vocabs'>
      <thead>
      <th>Internal Id</th>
      <th>Title</th>
      <th/>
      </thead>
      <tbody>
      <% SampleControlledVocab.all.each do |sample_controlled_vocab| %>
        <%= render partial: 'sample_controlled_vocab_table_row', locals: { sample_controlled_vocab: sample_controlled_vocab } %>
      <% end %>
      </tbody>
    </table>
  </div>
</div>


<script>

    var jobIdPresent = <%= session[:job_id].present? ? 'true' : 'false' %>;

    $j(document).ready(function() {

        ExtendedMetadataType.initializeNoticeFlash();

        if (sessionStorage.getItem('jobCompleted') === 'true') {
            sessionStorage.removeItem('jobCompleted');
            ExtendedMetadataType.updateJobStatusDisplay();
            ExtendedMetadataType.addNewMarker();
        }

        function checkJobStatus() {
            $j.ajax({
                url: "<%= populate_job_status_extended_metadata_types_path %>",
                dataType: "json",
                success: function(data) {
                    if (data.status === 'completed') {
                        console.log("Completed...");
                        sessionStorage.setItem('jobCompleted', 'true');
                        location.reload();
                        clearInterval(statusCheckInterval);
                    } else {
                        console.log("Processing...");
                    }
                }
            });
        }


        if (jobIdPresent) {
            var statusCheckInterval = setInterval(checkJobStatus, 5000); // Check every 5 seconds
            checkJobStatus(); // Check immediately on page load
        }
    });
</script>