<%# Selects a project implicitly when a study/investigation is selected from an assay/study.%>
<%# Populates the sharing form, prompts to apply the default policy%>

<%= content_tag :script, project_lookup_json(parents), type: 'application/json', id: 'project-lookup-json' %>
<script>
    Sharing.implicitProjects = [];

    $j(document).ready(function () {
        const projectsLookup = JSON.parse($j('#project-lookup-json').text());
        function setImplicitProjects(projectId) {
            if (projectId) {
                var projects = projectsLookup[parseInt(projectId)];
                if (projects && projects.length) {
                    Sharing.implicitProjects = projects;

                    for (var i = 0; i < projects.length; i++) {
                        Sharing.addPermissionForProject(projects[i]);
                    }
                }
            }
        }

        function applyDefaultPolicy(skipPrompt) {
            if (Sharing.implicitProjects.length === 1) {
                Sharing.fetchDefaultData(Sharing.implicitProjects[0]).then((data) => {
                    Sharing.defaultPolicyPrompt(Sharing.implicitProjects[0], data.policy, skipPrompt);
                });
            }
        }

        const select = $j('<%= select_id -%>');
        select.change(function () {
            setImplicitProjects($j(this).val());
            applyDefaultPolicy();
        });

        // Handle initial state
        setImplicitProjects(select.val());
        <% if action == :new %>
          applyDefaultPolicy(true); // Set default policy page load if it is a new resource
        <% end %>
    });
</script>
